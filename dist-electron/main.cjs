"use strict";var x=Object.defineProperty;var V=(p,e,n)=>e in p?x(p,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):p[e]=n;var C=(p,e,n)=>V(p,typeof e!="symbol"?e+"":e,n);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const o=require("electron"),h=require("node:path");let D=null;function j(){return D||(D=require("serialport").SerialPort||require("serialport")),D}class A{constructor(e){C(this,"ports",new Map);C(this,"mainWindow");this.mainWindow=e}async listPorts(){try{const e=j();if(!e)throw new Error("SerialPort module not loaded");return{success:!0,ports:await e.list()}}catch(e){return console.error("Error listing ports:",e),{success:!1,error:e.message}}}async open(e,n){this.ports.has(e)&&await this.close(e);const l=j();return new Promise(i=>{const f=new l({path:n.path,baudRate:n.baudRate,dataBits:n.dataBits||8,stopBits:n.stopBits||1,parity:n.parity||"none",autoOpen:!1});f.open(c=>{c?i({success:!1,error:c.message}):(this.ports.set(e,f),f.on("data",s=>{this.mainWindow&&!this.mainWindow.isDestroyed()&&this.mainWindow.webContents.send("serial:data",{connectionId:e,data:s})}),f.on("close",()=>{this.mainWindow&&!this.mainWindow.isDestroyed()&&this.mainWindow.webContents.send("serial:closed",{connectionId:e}),this.ports.delete(e)}),f.on("error",s=>{this.mainWindow&&!this.mainWindow.isDestroyed()&&this.mainWindow.webContents.send("serial:error",{connectionId:e,error:s.message})}),i({success:!0}))})})}async close(e){return new Promise(n=>{const l=this.ports.get(e);l&&l.isOpen?l.close(i=>{i?n({success:!1,error:i.message}):(this.ports.delete(e),n({success:!0}))}):(this.ports.delete(e),n({success:!0}))})}async write(e,n){return new Promise(l=>{const i=this.ports.get(e);if(i&&i.isOpen){const f=typeof n=="string"?n:Buffer.from(n);i.write(f,c=>{l(c?{success:!1,error:c.message}:{success:!0})})}else l({success:!1,error:"Port not open"})})}}process.env.APP_ROOT=h.join(__dirname,"..");const E=process.env.VITE_DEV_SERVER_URL,N=h.join(process.env.APP_ROOT,"dist-electron"),R=h.join(process.env.APP_ROOT,"dist");process.env.VITE_PUBLIC=E?h.join(process.env.APP_ROOT,"public"):R;let t,g=null;const W=h.join(o.app.getPath("userData"),"window-state.json"),$=()=>{if(t&&!t.isDestroyed()){const p=t.getBounds();require("fs").writeFileSync(W,JSON.stringify(p))}},U=()=>{try{const p=require("fs").readFileSync(W,"utf8");return JSON.parse(p)}catch{return{width:1e3,height:800}}};function B(){const p=U();t=new o.BrowserWindow({...p,icon:h.join(process.env.VITE_PUBLIC,"electron-vite.svg"),backgroundColor:"#1e1e1e",show:!0,webPreferences:{preload:h.join(__dirname,"preload.js")},titleBarStyle:"hidden",titleBarOverlay:{color:"#3c3c3c",symbolColor:"#cccccc",height:30}}),t.once("ready-to-show",()=>{t==null||t.show()}),t.on("resize",()=>$()),t.on("move",()=>$()),g=new A(t),o.ipcMain.handle("serial:list-ports",async()=>g==null?void 0:g.listPorts()),o.ipcMain.handle("serial:open",async(c,{connectionId:s,options:r})=>g==null?void 0:g.open(s,r)),o.ipcMain.handle("serial:close",async(c,{connectionId:s})=>g==null?void 0:g.close(s)),o.ipcMain.handle("serial:write",async(c,{connectionId:s,data:r})=>g==null?void 0:g.write(s,r));const e=require("mqtt"),n=new Map;o.ipcMain.handle("mqtt:connect",async(c,{connectionId:s,config:r})=>new Promise(u=>{if(n.has(s)){const a=n.get(s);a.connected&&a.end(!0),n.delete(s)}const m=r.protocol||"tcp";let d=r.host;if(d&&d.includes("://"))try{d=new URL(d).hostname}catch{d=d.split("://")[1]}let w=`${m}://${d}:${r.port}`;if(m==="ws"||m==="wss"){const a=r.path||"/mqtt",_=a.startsWith("/")?a:`/${a}`;w+=_}const P={clientId:r.clientId,username:r.username,password:r.password,keepalive:r.keepAlive||60,clean:r.cleanSession!==void 0?r.cleanSession:!0,connectTimeout:(r.connectTimeout||30)*1e3,reconnectPeriod:r.autoReconnect?1e3:0,wsOptions:{origin:"http://localhost",headers:{"User-Agent":`SerialTool/${o.app.getVersion()}`}}};console.log(`[MQTT] Connecting to ${w}`,P);let y=!1,S=null;try{S=e.connect(w,P)}catch(a){return console.error(`[MQTT] Sync Error ${s}:`,a),u({success:!1,error:a.message})}const T=()=>{y||(y=!0,n.set(s,S),u({success:!0}),t!=null&&t.isDestroyed()||t==null||t.webContents.send("mqtt:status",{connectionId:s,status:"connected"}),r.topics&&Array.isArray(r.topics)&&r.topics.forEach(a=>S.subscribe(a)))},M=a=>{y||(y=!0,S.end(!0),u({success:!1,error:a}))};S.on("connect",T),S.on("message",(a,_)=>{t!=null&&t.isDestroyed()||t==null||t.webContents.send("mqtt:message",{connectionId:s,topic:a,payload:_})}),S.on("error",a=>{console.error(`[MQTT] Error ${s}:`,a),y?t!=null&&t.isDestroyed()||t==null||t.webContents.send("mqtt:error",{connectionId:s,error:a.message}):M(a.message)}),S.on("close",()=>{console.log(`[MQTT] Closed: ${s}`),y?t!=null&&t.isDestroyed()||t==null||t.webContents.send("mqtt:status",{connectionId:s,status:"disconnected"}):M("Connection closed or timed out")})})),o.ipcMain.handle("mqtt:disconnect",async(c,{connectionId:s})=>{const r=n.get(s);return r?(r.end(),n.delete(s),{success:!0}):{success:!1,error:"Client not found"}}),o.ipcMain.handle("mqtt:publish",async(c,{connectionId:s,topic:r,payload:u,options:m})=>{const d=n.get(s);return d?new Promise(w=>{d.publish(r,Buffer.from(u),m,P=>{w(P?{success:!1,error:P.message}:{success:!0})})}):{success:!1,error:"Client not connected"}}),o.ipcMain.handle("mqtt:subscribe",async(c,{connectionId:s,topic:r})=>{const u=n.get(s);return u?(u.subscribe(r),{success:!0}):{success:!1}}),o.ipcMain.handle("mqtt:unsubscribe",async(c,{connectionId:s,topic:r})=>{const u=n.get(s);return u?(u.unsubscribe(r),{success:!0}):{success:!1}});const l=require("fs").promises,i=h.join(o.app.getPath("userData"),"sessions.json");o.ipcMain.handle("session:save",async(c,s)=>{try{return await l.writeFile(i,JSON.stringify(s,null,2)),{success:!0}}catch(r){return{success:!1,error:r.message}}}),o.ipcMain.handle("session:load",async()=>{try{const c=await l.readFile(i,"utf-8");return{success:!0,data:JSON.parse(c)}}catch(c){return c.code==="ENOENT"?{success:!0,data:[]}:{success:!1,error:c.message}}}),t.webContents.on("did-finish-load",()=>{t==null||t.webContents.send("main-process-message",new Date().toLocaleString())});const{exec:f}=require("node:child_process");o.ipcMain.handle("com0com:exec",async(c,s)=>new Promise(r=>{if(!s.startsWith("setupc"))return r({success:!1,error:"Unauthorized command"});(m=>{f(m,(d,w,P)=>{if(d)if(console.log(`[com0com] Command failed: ${m}`,d.message),m.startsWith("setupc")&&!m.includes("\\")&&!m.includes("/")){const y=h.join(o.app.getPath("userData"),"drivers","com0com","setupc.exe");console.log(`[com0com] Trying local path: ${y}`);const{spawn:S}=require("node:child_process"),T=h.dirname(y),a=m.substring(6).trim().split(/\s+/);console.log(`[com0com] Spawning: ${y} in ${T} with args:`,a);const _=S(y,a,{cwd:T,shell:!0});let O="",q="";_.stdout.on("data",b=>O+=b.toString()),_.stderr.on("data",b=>q+=b.toString()),_.on("error",b=>{console.log("[com0com] Spawn error:",b),r({success:!1,error:b.message,stderr:q})}),_.on("close",b=>{b===0?(console.log("[com0com] Spawn success"),r({success:!0,stdout:O})):(console.log(`[com0com] Spawn exited with ${b}`),r({success:!1,error:`Process exited with code ${b}`,stderr:q}))})}else r({success:!1,error:d.message,stderr:P});else r({success:!0,stdout:w})})})(s)})),o.ipcMain.handle("com0com:install",async()=>{const c=!!E;let s="";c?s=h.join(__dirname,"../resources/drivers/com0com_setup.exe"):s=h.join(process.resourcesPath,"resources/drivers/com0com_setup.exe");const r=h.join(o.app.getPath("userData"),"drivers","com0com");try{if(!(await l.stat(s)).isFile())return{success:!1,error:`Installer path is not a file: ${s}`}}catch{return{success:!1,error:`Installer not found at: ${s}`}}return new Promise(u=>{const{spawn:m}=require("node:child_process"),d=m(s,["/S",`/D=${r}`],{windowsHide:!1,shell:!0,cwd:h.dirname(s)});d.on("error",w=>{u({success:!1,error:w.message})}),d.on("close",w=>{u(w===0?{success:!0,path:r}:{success:!1,error:`Installer exited with code ${w}`})})})}),E?t.loadURL(E):t.loadFile(h.join(R,"index.html")),v=new F(t.webContents)}class F{constructor(e){C(this,"servers",new Map);C(this,"webContents");this.webContents=e}startServer(e){const n=require("net");if(this.servers.has(e))return{success:!1,error:"Server already running"};const l=n.createServer(i=>{i.on("data",f=>{this.webContents.send("tcp:data",{port:e,data:f})}),i.on("error",f=>{this.webContents.send("tcp:error",{port:e,error:f.message})}),i.on("close",()=>{this.webContents.send("tcp:client-disconnected",{port:e})})});return l.listen(e,()=>{this.servers.set(e,l),this.webContents.send("tcp:server-started",{port:e})}),l.on("error",i=>{this.webContents.send("tcp:error",{port:e,error:i.message})}),{success:!0}}stopServer(e){const n=this.servers.get(e);return n?(n.close(),this.servers.delete(e),this.webContents.send("tcp:server-stopped",{port:e}),!0):!1}write(e,n){}}let v=null;o.ipcMain.handle("tcp:start",async(p,e)=>v?v.startServer(e):{success:!1,error:"Service not initialized"});o.ipcMain.handle("tcp:stop",async(p,e)=>v?v.stopServer(e):!1);o.ipcMain.handle("tcp:write",async(p,{port:e,data:n})=>(v&&v.write(e,n),!0));o.app.on("window-all-closed",()=>{process.platform!=="darwin"&&(o.app.quit(),t=null)});o.app.on("activate",()=>{o.BrowserWindow.getAllWindows().length===0&&B()});o.app.whenReady().then(B);exports.MAIN_DIST=N;exports.RENDERER_DIST=R;exports.VITE_DEV_SERVER_URL=E;
